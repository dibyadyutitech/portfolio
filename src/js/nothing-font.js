// Nothing Font - Dot Matrix Generator
class NothingFont {
    constructor() {
        this.dotPatterns = {
            'A': [
                '  ██  ',
                ' █  █ ',
                '█    █',
                '██████',
                '█    █',
                '█    █',
                '      '
            ],
            'B': [
                '█████ ',
                '█    █',
                '█████ ',
                '█████ ',
                '█    █',
                '█████ ',
                '      '
            ],
            'C': [
                ' █████',
                '█     ',
                '█     ',
                '█     ',
                '█     ',
                ' █████',
                '      '
            ],
            'D': [
                '█████ ',
                '█    █',
                '█    █',
                '█    █',
                '█    █',
                '█████ ',
                '      '
            ],
            'E': [
                '██████',
                '█     ',
                '█████ ',
                '█     ',
                '█     ',
                '██████',
                '      '
            ],
            'F': [
                '██████',
                '█     ',
                '█████ ',
                '█     ',
                '█     ',
                '█     ',
                '      '
            ],
            'G': [
                ' █████',
                '█     ',
                '█  ███',
                '█    █',
                '█    █',
                ' █████',
                '      '
            ],
            'H': [
                '█    █',
                '█    █',
                '██████',
                '█    █',
                '█    █',
                '█    █',
                '      '
            ],
            'I': [
                '██████',
                '  ██  ',
                '  ██  ',
                '  ██  ',
                '  ██  ',
                '██████',
                '      '
            ],
            'J': [
                '██████',
                '    █ ',
                '    █ ',
                '    █ ',
                '█   █ ',
                ' ███  ',
                '      '
            ],
            'K': [
                '█   █ ',
                '█  █  ',
                '███   ',
                '███   ',
                '█  █  ',
                '█   █ ',
                '      '
            ],
            'L': [
                '█     ',
                '█     ',
                '█     ',
                '█     ',
                '█     ',
                '██████',
                '      '
            ],
            'M': [
                '█    █',
                '██  ██',
                '█ ██ █',
                '█    █',
                '█    █',
                '█    █',
                '      '
            ],
            'N': [
                '█    █',
                '██   █',
                '█ █  █',
                '█  █ █',
                '█   ██',
                '█    █',
                '      '
            ],
            'O': [
                ' ████ ',
                '█    █',
                '█    █',
                '█    █',
                '█    █',
                ' ████ ',
                '      '
            ],
            'P': [
                '█████ ',
                '█    █',
                '█████ ',
                '█     ',
                '█     ',
                '█     ',
                '      '
            ],
            'Q': [
                ' ████ ',
                '█    █',
                '█    █',
                '█  █ █',
                '█   █ ',
                ' ███ █',
                '      '
            ],
            'R': [
                '█████ ',
                '█    █',
                '█████ ',
                '█  █  ',
                '█   █ ',
                '█    █',
                '      '
            ],
            'S': [
                ' █████',
                '█     ',
                ' ████ ',
                '     █',
                '     █',
                '█████ ',
                '      '
            ],
            'T': [
                '██████',
                '  ██  ',
                '  ██  ',
                '  ██  ',
                '  ██  ',
                '  ██  ',
                '      '
            ],
            'U': [
                '█    █',
                '█    █',
                '█    █',
                '█    █',
                '█    █',
                ' ████ ',
                '      '
            ],
            'V': [
                '█    █',
                '█    █',
                '█    █',
                ' █  █ ',
                '  ██  ',
                '  ██  ',
                '      '
            ],
            'W': [
                '█    █',
                '█    █',
                '█    █',
                '█ ██ █',
                '██  ██',
                '█    █',
                '      '
            ],
            'X': [
                '█    █',
                ' █  █ ',
                '  ██  ',
                '  ██  ',
                ' █  █ ',
                '█    █',
                '      '
            ],
            'Y': [
                '█    █',
                ' █  █ ',
                '  ██  ',
                '  ██  ',
                '  ██  ',
                '  ██  ',
                '      '
            ],
            'Z': [
                '██████',
                '    █ ',
                '   █  ',
                '  █   ',
                ' █    ',
                '██████',
                '      '
            ],
            ' ': [
                '      ',
                '      ',
                '      ',
                '      ',
                '      ',
                '      ',
                '      '
            ],
            '0': [
                ' ████ ',
                '█    █',
                '█   ██',
                '█  █ █',
                '██   █',
                ' ████ ',
                '      '
            ],
            '1': [
                '  ██  ',
                ' ███  ',
                '  ██  ',
                '  ██  ',
                '  ██  ',
                '██████',
                '      '
            ],
            '2': [
                ' ████ ',
                '█    █',
                '    █ ',
                '  ██  ',
                ' █    ',
                '██████',
                '      '
            ],
            '3': [
                ' ████ ',
                '█    █',
                '  ███ ',
                '     █',
                '█    █',
                ' ████ ',
                '      '
            ],
            '4': [
                '█   █ ',
                '█   █ ',
                '██████',
                '    █ ',
                '    █ ',
                '    █ ',
                '      '
            ],
            '5': [
                '██████',
                '█     ',
                '█████ ',
                '     █',
                '█    █',
                ' ████ ',
                '      '
            ],
            '6': [
                ' ████ ',
                '█     ',
                '█████ ',
                '█    █',
                '█    █',
                ' ████ ',
                '      '
            ],
            '7': [
                '██████',
                '    █ ',
                '   █  ',
                '  █   ',
                ' █    ',
                '█     ',
                '      '
            ],
            '8': [
                ' ████ ',
                '█    █',
                ' ████ ',
                '█    █',
                '█    █',
                ' ████ ',
                '      '
            ],
            '9': [
                ' ████ ',
                '█    █',
                '█    █',
                ' █████',
                '     █',
                ' ████ ',
                '      '
            ],
            '?': [
                ' ████ ',
                '█    █',
                '   ██ ',
                '  ██  ',
                '      ',
                '  ██  ',
                '      '
            ],
            '!': [
                '  ██  ',
                '  ██  ',
                '  ██  ',
                '  ██  ',
                '      ',
                '  ██  ',
                '      '
            ],
            '.': [
                '      ',
                '      ',
                '      ',
                '      ',
                '      ',
                '  ██  ',
                '      '
            ],
            ',': [
                '      ',
                '      ',
                '      ',
                '      ',
                '  ██  ',
                ' ██   ',
                '      '
            ],
            ':': [
                '      ',
                '  ██  ',
                '      ',
                '      ',
                '  ██  ',
                '      ',
                '      '
            ],
            ';': [
                '      ',
                '  ██  ',
                '      ',
                '      ',
                '  ██  ',
                ' ██   ',
                '      '
            ],
            '-': [
                '      ',
                '      ',
                '██████',
                '      ',
                '      ',
                '      ',
                '      '
            ],
            '_': [
                '      ',
                '      ',
                '      ',
                '      ',
                '      ',
                '██████',
                '      '
            ],
            '(': [
                '   ██ ',
                '  ██  ',
                ' ██   ',
                ' ██   ',
                '  ██  ',
                '   ██ ',
                '      '
            ],
            ')': [
                ' ██   ',
                '  ██  ',
                '   ██ ',
                '   ██ ',
                '  ██  ',
                ' ██   ',
                '      '
            ]
        };
        
        this.isInitialized = false;
        this.processedElements = new Set();
    }
    
    init() {
        if (this.isInitialized) return;
        
        console.log('Initializing Nothing Font...');
        
        // Wait for DOM to be fully ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.processElements());
        } else {
            this.processElements();
        }
        
        this.isInitialized = true;
    }
    
    processElements() {
        // Find all elements with nothing-font class
        const elements = document.querySelectorAll('.nothing-font');
        console.log('Found nothing-font elements:', elements.length);
        
        elements.forEach((element, index) => {
            // Skip if already processed
            if (this.processedElements.has(element)) {
                console.log(`Element ${index} already processed, skipping`);
                return;
            }
            
            const originalText = element.textContent.trim();
            console.log(`Converting element ${index}: "${originalText}"`);
            
            if (originalText) {
                this.convertToMatrix(element, originalText);
                this.processedElements.add(element);
            }
        });
    }
    
    convertToMatrix(element, text) {
        const upperText = text.toUpperCase();
        console.log('Converting text to matrix:', upperText);
        
        // Store original text for accessibility
        const originalTextSpan = document.createElement('span');
        originalTextSpan.className = 'original-text';
        originalTextSpan.textContent = text;
        originalTextSpan.setAttribute('aria-hidden', 'true');
        
        const matrixContainer = document.createElement('div');
        matrixContainer.className = 'dot-matrix';
        matrixContainer.setAttribute('aria-label', text);
        
        // Create 7 rows (height of each character)
        for (let row = 0; row < 7; row++) {
            const rowElement = document.createElement('div');
            rowElement.className = 'dot-row';
            
            // Process each character
            for (let charIndex = 0; charIndex < upperText.length; charIndex++) {
                const char = upperText[charIndex];
                const pattern = this.dotPatterns[char] || this.dotPatterns[' '];
                const rowPattern = pattern[row];
                
                // Create letter container for this character
                if (row === 0) {
                    const letterElement = document.createElement('span');
                    letterElement.className = 'letter';
                    letterElement.setAttribute('data-char', char);
                    letterElement.setAttribute('data-index', charIndex);
                }
                
                // Create dots for this character's row
                for (let dotIndex = 0; dotIndex < rowPattern.length; dotIndex++) {
                    const dot = document.createElement('span');
                    dot.className = rowPattern[dotIndex] === '█' ? 'dot' : 'dot empty';
                    
                    // Add staggered animation delay for cool effect
                    const delay = (charIndex * 80) + (row * 15) + (dotIndex * 5);
                    dot.style.animationDelay = `${delay}ms`;
                    
                    rowElement.appendChild(dot);
                }
                
                // Add space between characters (except last one)
                if (charIndex < upperText.length - 1) {
                    for (let i = 0; i < 2; i++) {
                        const spaceDot = document.createElement('span');
                        spaceDot.className = 'dot empty';
                        rowElement.appendChild(spaceDot);
                    }
                }
            }
            
            matrixContainer.appendChild(rowElement);
        }
        
        // Clear element and add new content
        element.innerHTML = '';
        element.appendChild(originalTextSpan);
        element.appendChild(matrixContainer);
        
        console.log('Matrix conversion completed for:', text);
    }
    
    // Method to update text dynamically
    updateText(element, newText) {
        // Remove from processed set to allow re-processing
        this.processedElements.delete(element);
        
        // Set new text content
        element.textContent = newText;
        
        // Convert to matrix
        this.convertToMatrix(element, newText);
        
        // Add back to processed set
        this.processedElements.add(element);
    }
    
    // Method to reinitialize all elements
    reinitialize() {
        this.processedElements.clear();
        this.processElements();
    }
}

// Initialize when DOM is ready
function initializeNothingFont() {
    console.log('Initializing Nothing Font...');
    
    if (!window.nothingFont) {
        window.nothingFont = new NothingFont();
    }
    
    window.nothingFont.init();
}

// Multiple initialization strategies to ensure it works
document.addEventListener('DOMContentLoaded', initializeNothingFont);

// Fallback for when DOMContentLoaded has already fired
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeNothingFont);
} else {
    // DOM is already ready
    setTimeout(initializeNothingFont, 50);
}

// Additional fallback on window load
window.addEventListener('load', () => {
    setTimeout(() => {
        if (!window.nothingFont || !window.nothingFont.isInitialized) {
            console.log('Fallback: Initializing Nothing Font on window load');
            initializeNothingFont();
        }
    }, 100);
});

// Export for external use
window.NothingFont = NothingFont;

// Manual trigger function for debugging
window.initNothingFont = initializeNothingFont;

// Force re-initialization function
window.reinitNothingFont = function() {
    console.log('Force reinitializing Nothing Font...');
    if (window.nothingFont) {
        window.nothingFont.reinitialize();
    } else {
        initializeNothingFont();
    }
};

// Auto-retry mechanism
let retryCount = 0;
const maxRetries = 3;

function retryInitialization() {
    if (retryCount >= maxRetries) return;
    
    setTimeout(() => {
        const nothingFontElements = document.querySelectorAll('.nothing-font');
        const hasMatrixContent = Array.from(nothingFontElements).some(el => 
            el.querySelector('.dot-matrix')
        );
        
        if (nothingFontElements.length > 0 && !hasMatrixContent) {
            console.log(`Retry ${retryCount + 1}: Nothing Font elements found but not converted`);
            initializeNothingFont();
            retryCount++;
            retryInitialization();
        }
    }, 1000 * (retryCount + 1));
}

// Start retry mechanism
retryInitialization();